(function(){"use strict";var e={8343:function(e,t,r){var n=r(9963),o=r(6252);function s(e,t){const r=(0,o.up)("router-link"),n=(0,o.up)("router-view");return(0,o.wg)(),(0,o.iD)(o.HY,null,[(0,o._)("nav",null,[(0,o.Wm)(r,{to:"/"},{default:(0,o.w5)((()=>[(0,o.Uk)("Home")])),_:1}),(0,o.Uk)(" | "),(0,o.Wm)(r,{to:"/login"},{default:(0,o.w5)((()=>[(0,o.Uk)("Login")])),_:1})]),(0,o.Wm)(n)],64)}var i=r(3744);const a={},l=(0,i.Z)(a,[["render",s]]);var u=l,d=r(2201);var g=r(3577);const c=(0,o._)("br",null,null,-1),y=(0,o._)("br",null,null,-1),p=(0,o._)("br",null,null,-1),h=(0,o._)("br",null,null,-1),f=(0,o._)("br",null,null,-1),I=(0,o._)("br",null,null,-1);function m(e,t,r,s,i,a){return(0,o.wg)(),(0,o.iD)("div",null,[(0,o.Uk)(" Username: "),(0,o.wy)((0,o._)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=e=>i.loginInfo.userID=e),placeholder:"Input username"},null,512),[[n.nr,i.loginInfo.userID]]),c,y,(0,o.Uk)(" Password: "),(0,o.wy)((0,o._)("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=e=>i.loginInfo.password=e),placeholder:"Input pwd"},null,512),[[n.nr,i.loginInfo.password]]),p,h,(0,o._)("button",{onClick:t[2]||(t[2]=(...e)=>a.login&&a.login(...e))},"Login"),f,I])}var K=r(3907),v={setup(){const e=(0,K.oR)();console.log("store:::::"),console.log(e);(0,d.tv)();return{store:e}},name:"LoginPage",data(){return{loginInfo:{userID:"",password:"",registrationID:""},responseResult:{uid:"",registrationId:"",identityKeyPair:"",preKeys:"",signedPreKey:""}}},methods:{login(){this.$http.post("/login",{username:this.loginInfo.userID,password:this.loginInfo.password}).then((e=>{200===e.data.code?(this.store.dispatch("registration",this.loginInfo.userID),B.replace("/chat")):alert("wrong")}))}}};const w=(0,i.Z)(v,[["render",m]]);var b=w;function k(e,t,r,s,i,a){return(0,o.wg)(),(0,o.iD)("div",null,[(0,o.wy)((0,o._)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=e=>i.message.destinationUserId=e),placeholder:"destinationUserID"},null,512),[[n.nr,i.message.destinationUserId]]),(0,o.wy)((0,o._)("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=e=>i.message.destinationRegistrationId=e),placeholder:"destinationRegistrationID"},null,512),[[n.nr,i.message.destinationRegistrationId]]),(0,o.wy)((0,o._)("input",{type:"text","onUpdate:modelValue":t[2]||(t[2]=e=>i.message.myMsg=e),placeholder:"message"},null,512),[[n.nr,i.message.myMsg]]),(0,o._)("button",{onClick:t[3]||(t[3]=(...e)=>a.send&&a.send(...e))},"Send"),(0,o._)("button",{onClick:t[4]||(t[4]=(...e)=>a.get&&a.get(...e))},"GetKeys"),(0,o._)("div",null,(0,g.zw)(i.recvMsg),1),(0,o._)("div",null,(0,g.zw)(i.msg),1),(0,o._)("div",null,[(0,o._)("button",{onClick:t[5]||(t[5]=(...e)=>a.onStore&&a.onStore(...e))},"Store"),(0,o._)("button",{onClick:t[6]||(t[6]=(...e)=>a.onCheck&&a.onCheck(...e))},"Check"),(0,o._)("button",{onClick:t[7]||(t[7]=(...e)=>a.onDelete&&a.onDelete(...e))},"Delete")])])}var P={setup(){const e=(0,K.oR)();return console.log(e),{store:e}},name:"ChatPage",created(){console.log("created"),this.initWebSocket()},destroyed(){this.websocketClose()},data(){return{message:{destinationUserId:"",destinationRegistrationId:"",myMsg:""},websocket:null,recvMsg:{},msg:""}},methods:{send(){console.log("send"),this.store.dispatch("encrypt-message",this.message).then((e=>{this.websocketSend(JSON.stringify(e))}))},get(){this.$http.get("/keyOf/"+this.message.destinationUserId).then((e=>{console.log(e),this.recvMsg=e.data,this.store.dispatch("process-key",e.data).then((e=>{!0===e&&console.log("ok")}))}))},onConfirm(){let e={code:1,item:"传输数据"};this.websocketSend(JSON.stringify(e))},initWebSocket(){let e="ws://192.168.190.1:9090/websocket/"+this.store.getters.getUserId;this.websock=new WebSocket(e),this.websock.onmessage=this.websocketOnMessage,this.websock.onerror=this.websocketOnError,this.websock.onopen=this.websocketOnOpen,this.websock.onclose=this.websocketClose},websocketOnOpen(){let e={code:0,msg:{userId:this.store.getters.getUserId,registrationId:this.store.getters.getRegistrationId}};this.websocketSend(JSON.stringify(e))},websocketOnError(){console.log("WebSocket连接失败")},websocketOnMessage(e){let t,r=JSON.parse(e.data);console.log(r),console.log("prepare to decrypt"),this.store.dispatch("decrypt-message",r).then((e=>{console.log(e),t=e,this.msg=e}))},websocketSend(e){this.websock.send(e)},websocketClose(e){console.log("已关闭连接",e)},onStore(){this.store.dispatch("store-info").then((e=>{console.log(e)}))},onCheck(){this.store.dispatch("check-info",this.message.destinationUserId).then((e=>{console.log(e)}))},onDelete(){this.store.dispatch("delete-info",this.message.destinationUserId).then((e=>{console.log(e)}))}}};const S=(0,i.Z)(P,[["render",k]]);var _=S;const U=(0,o._)("br",null,null,-1),O=(0,o._)("br",null,null,-1),D=(0,o._)("br",null,null,-1),C=(0,o._)("br",null,null,-1),R=(0,o._)("br",null,null,-1),x=(0,o._)("br",null,null,-1);function M(e,t,r,s,i,a){return(0,o.wg)(),(0,o.iD)("div",null,[(0,o.Uk)(" Username: "),(0,o.wy)((0,o._)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=e=>i.loginInfo.userID=e),placeholder:"Input username"},null,512),[[n.nr,i.loginInfo.userID]]),U,O,(0,o.Uk)(" Password: "),(0,o.wy)((0,o._)("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=e=>i.loginInfo.password=e),placeholder:"Input pwd"},null,512),[[n.nr,i.loginInfo.password]]),D,C,(0,o._)("button",{onClick:t[2]||(t[2]=(...e)=>a.register&&a.register(...e))},"Register"),R,x,(0,o._)("p",null,(0,g.zw)(this.store.state.registrationId),1)])}var E={setup(){const e=(0,K.oR)();console.log(e);(0,d.tv)();return{store:e}},name:"Register",data(){return{loginInfo:{userID:"",password:"",registrationID:""},responseResult:[]}},methods:{register(){this.$http.post("/register",{username:this.loginInfo.userID}).then((e=>{200===e.data.code?this.store.dispatch("registration",this.loginInfo.userID).then((e=>{console.log(`res: ${e}`),this.store.dispatch("store-info"),this.$http.post("/register1",{username:this.loginInfo.userID,password:this.loginInfo.password,registrationID:e.registrationId}).then((e=>{200===e.data.code?this.store.dispatch("send-keys-to-server").then((e=>{"ok"===e&&(alert("registered successfully!"),B.replace("/login"))})):alert("strange error")}))})):406===e.data.code?alert("Invalid user name!"):alert("User already exists!")}))}}};const A=(0,i.Z)(E,[["render",M]]);var N=A;const T=[{path:"/login",name:"Login",component:b},{path:"/chat",name:"Chat",component:_},{path:"/register",name:"Register",component:N}],W=(0,d.p7)({history:(0,d.r5)(),routes:T});var B=W,j=(r(3767),r(8585),r(8696),r(2801),r(7658),r(682)),L=r.n(j);const V=window.libsignal;function $(){this.store={}}$.prototype={Direction:{SENDING:1,RECEIVING:2},getIdentityKeyPair:function(){return Promise.resolve(this.get("identityKey"))},getLocalRegistrationId:function(){return Promise.resolve(this.get("registrationId"))},put:function(e,t){if(void 0===e||void 0===t||null===e||null===t)throw new Error("Tried to store undefined/null");this.store[e]=t},get:function(e,t){if(null===e||void 0===e)throw new Error("Tried to get value for undefined/null key");return e in this.store?this.store[e]:t},remove:function(e){if(null===e||void 0===e)throw new Error("Tried to remove value for undefined/null key");delete this.store[e]},isTrustedIdentity:function(e,t,r){if(null===e||void 0===e)throw new Error("tried to check identity key for undefined/null key");if(!(t instanceof ArrayBuffer))throw new Error("Expected identityKey to be an ArrayBuffer");let n=this.get("identityKey"+e);return void 0===n?Promise.resolve(!0):Promise.resolve(L().toString(t)===L().toString(n))},loadIdentityKey:function(e){if(null===e||void 0===e)throw new Error("Tried to get identity key for undefined/null key");return Promise.resolve(this.get("identityKey"+e))},saveIdentity:function(e,t){if(null===e||void 0===e)throw new Error("Tried to put identity key for undefined/null key");let r=new V.SignalProtocolAddress.fromString(e),n=this.get("identityKey"+r.getName());return this.put("identityKey"+r.getName(),t),n&&L().toString(t)!==L().toString(n)?Promise.resolve(!0):Promise.resolve(!1)},loadPreKey:function(e){let t=this.get("25519KeypreKey"+e);return void 0!==t&&(t={pubKey:t.pubKey,privKey:t.privKey}),Promise.resolve(t)},storePreKey:function(e,t){return Promise.resolve(this.put("25519KeypreKey"+e,t))},removePreKey:function(e){return Promise.resolve(this.remove("25519KeypreKey"+e))},loadSignedPreKey:function(e){let t=this.get("25519KeysignedKey"+e);return void 0!==t&&(t={pubKey:t.pubKey,privKey:t.privKey}),Promise.resolve(t)},storeSignedPreKey:function(e,t){return Promise.resolve(this.put("25519KeysignedKey"+e,t))},removeSignedPreKey:function(e){return Promise.resolve(this.remove("25519KeysignedKey"+e))},loadSession:function(e){return Promise.resolve(this.get("session"+e))},storeSession:function(e,t){return Promise.resolve(this.put("session"+e,t))},removeSession:function(e){return Promise.resolve(this.remove("session"+e))},removeAllSessions:function(e){for(let t in this.store)t.startsWith("session"+e)&&delete this.store[t];return Promise.resolve()}};const J=$;var Z=r(6154);const G=window.libsignal,z=G.KeyHelper,H=Z.Z.create({baseURL:"http://localhost:9090"}),q=e=>{let t="",r=new Uint8Array(e),n=r.byteLength;for(let o=0;o<n;o++)t+=String.fromCharCode(r[o]);return window.btoa(t)};var F=function(){var e=(new ArrayBuffer).__proto__;return{toString:function(e){return"string"==typeof e?e:new dcodeIO.ByteBuffer.wrap(e).toString("binary")},toArrayBuffer:function(t){if(void 0!==t){if(t===Object(t)&&t.__proto__===e)return t;if("string"!=typeof t)throw new Error("Tried to convert a non-string of type "+typeof t+" to an array buffer");return t,new dcodeIO.ByteBuffer.wrap(t,"binary").toArrayBuffer()}},isEqual:function(e,t){if(void 0===e||void 0===t)return!1;e=F.toString(e),t=F.toString(t);var r=Math.max(e.length,t.length);if(r<5)throw new Error("a/b compare too short");return e.substring(0,Math.min(r,e.length))===t.substring(0,Math.min(r,t.length))}}}();const Y=e=>{let t=window.atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n.buffer},Q=5;async function X(e){let t=[];for(let o=0;o<Q;o++)t.push(z.generatePreKey(e+o+1));const r=await Promise.all(t),n=r.map((e=>({keyId:e.keyId,keyPair:e.keyPair})));return{preKeys:n}}var ee=(0,K.MT)({state:{userId:null,registrationId:null,identityKeyPair:null,signedPreKey:null,preKeys:null,store:null},getters:{getUserId(e){return e.userId},getRegistrationId(e){return console.log(`getters ${e.registrationId}`),e.registrationId},getUser(e){return e.userId+"-"+e.registrationId}},mutations:{["setup-registration"](e,[t,r,n,o,s]){console.log("setup registration"),console.log(t),console.log(r),e.userId=parseInt(t),e.registrationId=parseInt(r),console.log(e.userId),console.log(e.registrationId),e.identityKeyPair=n,e.signedPreKey=s,e.preKeys=o,console.log(n),e.store=new J,e.store.put("userId",t),e.store.put("registrationId",r),e.store.put("identityKey",n),o.forEach((({keyId:t,keyPair:r})=>{e.store.storePreKey(t,r)})),e.store.storeSignedPreKey(s.keyId,s.keyPair)}},actions:{async["registration"](e,t){if(console.log("inside registration"),null!=localStorage.getItem(t)){console.log("not null");let r=JSON.parse(localStorage.getItem(t));const n=parseInt(r.userId),o=parseInt(r.registrationId);let s=r.identityKeyPair;s.pubKey=Y(s.pubKey),s.privKey=Y(s.privKey);let i=r.signedPreKey;i.keyId=parseInt(i.keyId),i.keyPair.pubKey=Y(i.keyPair.pubKey),i.keyPair.privKey=Y(i.keyPair.privKey),i.signature=Y(i.signature);let a=r.preKeys.map((e=>({keyId:parseInt(e.keyId),keyPair:{pubKey:Y(e.keyPair.pubKey),privKey:Y(e.keyPair.privKey)}})));return e.commit("setup-registration",[n,o,s,a,i]),{registrationId:o,code:400}}console.info(`Generating registration ID for user [${t}]`);const r=parseInt(t);console.log(r);const n=parseInt(z.generateRegistrationId());console.log(n);const o=await z.generateIdentityKeyPair();console.log(o);const{preKeys:s}=await X(n),i=await z.generateSignedPreKey(o,n);return console.log(i),e.commit("setup-registration",[r,n,o,s,i]),{registrationId:n,code:200}},async["send-keys-to-server"](e){let t={userId:parseInt(e.state.userId),registrationId:parseInt(e.state.registrationId),identityKey:q(e.state.identityKeyPair.pubKey),signedPreKey:{keyId:parseInt(e.state.signedPreKey.keyId),publicKey:q(e.state.signedPreKey.keyPair.pubKey),signature:q(e.state.signedPreKey.signature)},preKeys:e.state.preKeys.map((e=>({keyId:parseInt(e.keyId),publicKey:q(e.keyPair.pubKey)})))};return console.log(t),await H.post("/keysOf/"+e.state.userId,t),"ok"},async["process-key"](e,t){console.log(t);let r=parseInt(t.userId),n=parseInt(t.registrationId);const o=new G.SignalProtocolAddress(n,r),s=new G.SessionBuilder(e.state.store,o);let i=t;return i.identityKey=Y(i.identityKey),i.signedPreKey.publicKey=Y(i.signedPreKey.publicKey),i.signedPreKey.signature=Y(i.signedPreKey.signature),i.preKey.publicKey=Y(i.preKey.publicKey),console.log("Pre keys processed:",i),await s.processPreKey(i),!0},async["encrypt-message"](e,t){console.log(t);const r=new G.SignalProtocolAddress(t.destinationRegistrationId,t.destinationUserId);console.log(e.state.store),console.log(e.state.userId),console.log(e.state.registrationId);const n=new G.SessionCipher(e.state.store,r),o=await n.encrypt(t.myMsg);console.log(3),console.log(t.destinationUserId),console.log(t.destinationRegistrationId);let s={destinationUserId:t.destinationUserId,destinationRegistrationId:t.destinationRegistrationId,sourceUserId:e.state.userId,sourceRegistrationId:e.state.registrationId,ciphertext:o};return console.log(s),s},async["decrypt-message"](e,t){const r=parseInt(t.sourceUserId),n=parseInt(t.sourceRegistrationId);let o=new G.SignalProtocolAddress(n,r);console.log("context.  .store:"+e.state.store);localStorage.getItem(t.sourceUserId);let s,i=new G.SessionCipher(e.state.store,o);3===parseInt(t.ciphertext.type)?(console.log("Cipher message type 3: decryptPreKeyWhisperMessage"),console.log(t.ciphertext.body),s=await i.decryptPreKeyWhisperMessage(t.ciphertext.body,"binary")):1===parseInt(t.ciphertext.type)&&(console.log("Cipher message type 1: decryptWhisperMessage"),s=await i.decryptWhisperMessage(t.ciphertext.body,"binary")),console.log(s);let a=F.toString(s);return console.log("Decrypted message:",a),a},async["store-info"](e){let t={userId:e.state.userId,registrationId:e.state.registrationId,identityKeyPair:{pubKey:q(e.state.identityKeyPair.pubKey),privKey:q(e.state.identityKeyPair.privKey)},signedPreKey:{keyId:parseInt(e.state.signedPreKey.keyId),keyPair:{pubKey:q(e.state.signedPreKey.keyPair.pubKey),privKey:q(e.state.signedPreKey.keyPair.privKey)},signature:q(e.state.signedPreKey.signature)},preKeys:e.state.preKeys.map((e=>({keyId:parseInt(e.keyId),keyPair:{pubKey:q(e.keyPair.pubKey),privKey:q(e.keyPair.privKey)}})))};return localStorage.setItem(e.state.userId,JSON.stringify(t)),200},async["check-info"](e,t){let r;return r=JSON.parse(localStorage.getItem(t)),r},async["delete-info"](e,t){return localStorage.removeItem(t),400}},modules:{}});r(9812);Z.Z.defaults.baseURL="/api";const te=(0,n.ri)(u);te.config.globalProperties.$http=Z.Z,te.use(ee).use(B).mount("#app")}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.m=e,function(){var e=[];r.O=function(t,n,o,s){if(!n){var i=1/0;for(d=0;d<e.length;d++){n=e[d][0],o=e[d][1],s=e[d][2];for(var a=!0,l=0;l<n.length;l++)(!1&s||i>=s)&&Object.keys(r.O).every((function(e){return r.O[e](n[l])}))?n.splice(l--,1):(a=!1,s<i&&(i=s));if(a){e.splice(d--,1);var u=o();void 0!==u&&(t=u)}}return t}s=s||0;for(var d=e.length;d>0&&e[d-1][2]>s;d--)e[d]=e[d-1];e[d]=[n,o,s]}}(),function(){r.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return r.d(t,{a:t}),t}}(),function(){r.d=function(e,t){for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}}(),function(){r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={143:0};r.O.j=function(t){return 0===e[t]};var t=function(t,n){var o,s,i=n[0],a=n[1],l=n[2],u=0;if(i.some((function(t){return 0!==e[t]}))){for(o in a)r.o(a,o)&&(r.m[o]=a[o]);if(l)var d=l(r)}for(t&&t(n);u<i.length;u++)s=i[u],r.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return r.O(d)},n=self["webpackChunke2ee_vue"]=self["webpackChunke2ee_vue"]||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))}();var n=r.O(void 0,[998],(function(){return r(8343)}));n=r.O(n)})();
//# sourceMappingURL=app.de195268.js.map